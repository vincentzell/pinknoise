<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Sleepy Bobby">
    <title>Sleepy Bobby</title>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --primary: #38bdf8;
            --accent: #fb7185;
            --bird-grey: #b8b0a5;
            --bird-dark-grey: #8d7e71;
            --bird-orange: #e65a28;
            --branch-brown: #8b5d43;
        }

        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; position: fixed; background: var(--bg); font-family: system-ui, sans-serif; }
        body { display: flex; align-items: center; justify-content: center; }

        .container { width: 100%; max-width: 380px; padding: 20px; text-align: center; position: relative; z-index: 10; }

        .card {
            background: var(--card); padding: 2.5rem 2rem; border-radius: 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05);
            backdrop-filter: blur(10px); position: relative; z-index: 20; color: var(--text);
        }

        /* --- BOBBY & SA BRANCHE --- */
        .play-btn-wrapper { position: relative; margin: 10px auto 30px; width: 160px; height: 150px; display: flex; justify-content: center; align-items: center; }
        .play-btn { width: 140px; height: 140px; border: none; background: none; cursor: pointer; position: relative; z-index: 60; display: flex; flex-direction: column; align-items: center; justify-content: center; outline: none; }
        
        .branch { position: absolute; width: 140px; height: 12px; background: var(--branch-brown); bottom: 35px; left: 50%; transform: translateX(-50%); border-radius: 10px; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .bird-body { width: 90px; height: 100px; background: var(--bird-grey); border-radius: 50% 50% 45% 45%; position: relative; overflow: hidden; z-index: 30; }
        .head-top { position: absolute; top: 0; left: 20%; width: 60%; height: 25px; background: var(--bird-dark-grey); border-radius: 0 0 15px 15px; }
        .chest { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 70px; height: 70px; background: var(--bird-orange); border-radius: 50%; }
        .eyes { position: absolute; top: 35px; width: 45px; display: flex; justify-content: space-between; left: 50%; transform: translateX(-50%); }
        .eye { width: 7px; height: 7px; background: #1a1a1a; border-radius: 50%; transition: all 0.3s ease; }
        .beak { position: absolute; top: 42px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 7px solid #f1c40f; }
        .legs { display: flex; justify-content: center; gap: 15px; position: absolute; bottom: 38px; z-index: 40; }
        .leg { width: 8px; height: 12px; background: var(--bird-dark-grey); border-radius: 3px; }
        .tail { width: 25px; height: 40px; background: var(--bird-grey); border-radius: 0 0 10px 10px; position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); z-index: 10; }

        /* Animations */
        .play-btn.playing .bird-body { animation: breathe 4s ease-in-out infinite; }
        .play-btn.playing .eye { height: 2px; border-radius: 2px; margin-top: 3px; }
        .playing-state .branch { animation: sway 4s ease-in-out infinite; }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.04); } }
        @keyframes sway { 0%, 100% { transform: translateX(-50%) rotate(0deg); } 50% { transform: translateX(-50%) rotate(1.5deg); } }

        /* --- EFFETS --- */
        .anim-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 150; overflow: hidden; }
        .ripple { position: absolute; border: 2px solid var(--primary); border-radius: 50%; transform: translate(-50%, -50%); animation: rippleEffect 4s cubic-bezier(0, 0.3, 0.7, 1) forwards; opacity: 0; }
        @keyframes rippleEffect { 0% { width: 0; height: 0; opacity: 0.6; } 100% { width: 600px; height: 600px; opacity: 0; } }
        
        .zzz-emitter { position: absolute; top: 45%; left: 50%; opacity: 0; transition: opacity 0.5s; }
        .zzz-emitter.active { opacity: 1; }
        .z { position: absolute; color: var(--accent); font-weight: bold; opacity: 0; animation: sleepZ 4s infinite linear; }
        @keyframes sleepZ { 0% { opacity: 0; transform: translate(-10px, 0) scale(0.5); } 20% { opacity: 0.8; } 100% { opacity: 0; transform: translate(50px, -200px) scale(1.8) rotate(20deg); } }

        /* CONTROLES */
        .control-group { text-align: left; margin-top: 15px; }
        .label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; opacity: 0.5; margin-bottom: 5px; display: block; }
        select { width: 100%; padding: 12px; border-radius: 12px; background: #2d3748; border: 1px solid rgba(255,255,255,0.1); color: white; appearance: none; cursor: pointer; font-size: 0.95rem; outline: none; }
        input[type=range] { width: 100%; height: 6px; appearance: none; background: rgba(255,255,255,0.1); border-radius: 5px; outline: none; }
        input[type=range]::-webkit-slider-thumb { appearance: none; width: 22px; height: 22px; background: var(--primary); border-radius: 50%; border: 3px solid var(--card); cursor: pointer; }
        
        #bobbyPhrase { min-height: 40px; line-height: 1.4; }
    </style>
</head>
<body>

    <div class="anim-container" id="animContainer">
        <div id="zzzLayer" class="zzz-emitter">
            <div class="z" style="animation-delay:0s; font-size:1.5rem">z</div>
            <div class="z" style="animation-delay:2s; font-size:2.5rem">z</div>
        </div>
    </div>

    <div class="container" id="mainContainer">
        <div class="card">
            <h1 style="margin: 0 0 5px 0;">Sleepy Bobby</h1>
            <p id="bobbyPhrase" style="margin: 0 0 20px 0; opacity: 0.7; font-size: 0.9rem;"></p>
            
            <div class="play-btn-wrapper">
                <button id="playBtn" class="play-btn">
                    <div class="bird-body">
                        <div class="head-top"></div><div class="chest"></div>
                        <div class="eyes"><div class="eye"></div><div class="eye"></div></div>
                        <div class="beak"></div>
                    </div>
                    <div class="legs"><div class="leg"></div><div class="leg"></div></div>
                    <div class="tail"></div>
                    <div class="branch"></div>
                </button>
            </div>

            <div class="control-group">
                <span class="label">Ambiance</span>
                <select id="modeSelect">
                    <option value="river" selected>Rivière Douce</option>
                    <option value="pink">Bruit Rose</option>
                </select>
            </div>
            
            <div class="control-group">
                <span class="label">Minuteur</span>
                <select id="timerSelect">
                    <option value="0" data-label="∞">∞</option>
                    <option value="5" data-label="5 Minutes">5 Minutes</option>
                    <option value="10" data-label="10 Minutes">10 Minutes</option>
                    <option value="15" data-label="15 Minutes">15 Minutes</option>
                    <option value="30" data-label="30 Minutes">30 Minutes</option>
                    <option value="60" data-label="60 Minutes">60 Minutes</option>
                </select>
            </div>

            <div class="control-group">
                <span class="label">Volume <span id="volPerc">100%</span></span>
                <input type="range" id="volume" min="0" max="1" step="0.01" value="1.0">
            </div>
        </div>
    </div>

    <script>
        const phrases = [
            "Bobby ébouriffe ses plumes pour te border.",
            "Chut... Bobby troque son chant contre un doux murmure.",
            "Un petit nid de sons pour une grande nuit de rêves.",
            "Bobby ferme un œil... puis l'autre... avec toi.",
            "Bobby says bonne nuit and wishes you sweet dreams.",
            "Un battement d'ailes, un petit chirp, et hop au dodo !",
            "Bobby is learning to snore in two languages.",
            "Bobby range son bec sous son aile, c'est l'heure.",
            "Le dernier rouge-gorge couché éteint la lune !",
            "Bobby rêve de trèfles irlandais et de jardins français.",
            "De Connemara à la Provence, Bobby te chante le sommeil.",
            "A little piece of Ireland, un petit coin de France, et beaucoup de dodo.",
            "Bobby has his head in the clouds, entre Dublin et Paris.",
            "Slán abhaile... Bobby te souhaite un doux retour au pays des songes."
        ];

        document.getElementById('bobbyPhrase').textContent = phrases[Math.floor(Math.random() * phrases.length)];

        let audioCtx, sourceNode, gainNode, timerInterval, rippleInterval;
        let isPlaying = false;
        let fadeStarted = false;

        const btn = document.getElementById('playBtn');
        const mainContainer = document.getElementById('mainContainer');
        const animContainer = document.getElementById('animContainer');
        const modeSelect = document.getElementById('modeSelect');
        const timerSelect = document.getElementById('timerSelect');
        const volSlider = document.getElementById('volume');
        const zzzLayer = document.getElementById('zzzLayer');

        function createRipple() {
            if (!isPlaying || modeSelect.value !== 'river') return;
            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            const x = 50 + (Math.random() * 40 - 20);
            const y = 45 + (Math.random() * 30 - 15);
            ripple.style.left = `${x}%`; ripple.style.top = `${y}%`;
            animContainer.appendChild(ripple);
            setTimeout(() => ripple.remove(), 4000);
        }

        function createRiverBuffer(ctx) {
            const buf = ctx.createBuffer(1, ctx.sampleRate * 6, ctx.sampleRate);
            const d = buf.getChannelData(0);
            let lp0 = 0, lp1 = 0;
            for (let i = 0; i < d.length; i++) {
                const w = Math.random() * 2 - 1;
                lp0 = 0.95 * lp0 + 0.05 * w;
                lp1 = 0.95 * lp1 + 0.05 * lp0;
                d[i] = lp1 * (Math.sin(i * 0.00004) * 0.2 + 0.8) * 3.5;
            }
            return buf;
        }

        function createPinkNoiseBuffer(ctx) {
            const buf = ctx.createBuffer(1, ctx.sampleRate * 2, ctx.sampleRate);
            const d = buf.getChannelData(0);
            let b0=0, b1=0, b2=0, b3=0, b4=0, b5=0, b6=0;
            for (let i = 0; i < d.length; i++) {
                let w = Math.random() * 2 - 1;
                b0 = 0.99886*b0 + w*0.0555179; b1 = 0.99332*b1 + w*0.0750759;
                b2 = 0.96900*b2 + w*0.1538520; b3 = 0.86650*b3 + w*0.3104856;
                b4 = 0.55000*b4 + w*0.5329522; b5 = -0.7616*b5 - w*0.0168980;
                d[i] = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + w*0.5362) * 0.12;
                b6 = w * 0.11592;
            }
            return buf;
        }

        function updateAnims() {
            zzzLayer.classList.toggle('active', isPlaying && modeSelect.value === 'pink');
            clearInterval(rippleInterval);
            if (isPlaying && modeSelect.value === 'river') {
                rippleInterval = setInterval(createRipple, 1500);
                createRipple();
            }
        }

        function startTimer(minutes) {
            resetTimerLabels();
            fadeStarted = false;
            if (minutes === 0) return;
            let timeLeft = minutes * 60;
            
            timerInterval = setInterval(() => {
                timeLeft--;
                const opt = timerSelect.options[timerSelect.selectedIndex];
                const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
                opt.textContent = `⏳ ${m}:${s.toString().padStart(2, '0')}`;

                if (timeLeft <= 30 && !fadeStarted && gainNode) {
                    fadeStarted = true;
                    const now = audioCtx.currentTime;
                    gainNode.gain.cancelScheduledValues(now);
                    gainNode.gain.setValueAtTime(gainNode.gain.value, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + timeLeft);
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if (isPlaying) togglePlay();
                }
            }, 1000);
        }

        function resetTimerLabels() {
            clearInterval(timerInterval);
            Array.from(timerSelect.options).forEach(opt => opt.textContent = opt.getAttribute('data-label'));
        }

        async function togglePlay() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (!isPlaying) {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                sourceNode = audioCtx.createBufferSource();
                sourceNode.buffer = (modeSelect.value === 'river') ? createRiverBuffer(audioCtx) : createPinkNoiseBuffer(audioCtx);
                sourceNode.loop = true;
                gainNode = audioCtx.createGain();
                gainNode.gain.value = volSlider.value;
                sourceNode.connect(gainNode).connect(audioCtx.destination);
                sourceNode.start();
                btn.classList.add('playing');
                mainContainer.classList.add('playing-state');
                isPlaying = true;
                startTimer(parseInt(timerSelect.value));
            } else {
                if(sourceNode) { 
                    try { sourceNode.stop(); sourceNode.disconnect(); } catch(e) {}
                }
                resetTimerLabels();
                btn.classList.remove('playing');
                mainContainer.classList.remove('playing-state');
                isPlaying = false;
                fadeStarted = false;
            }
            updateAnims();
        }

        btn.addEventListener('click', togglePlay);
        modeSelect.addEventListener('change', () => { if (isPlaying) { togglePlay(); togglePlay(); } });
        timerSelect.addEventListener('change', () => { if (isPlaying) startTimer(parseInt(timerSelect.value)); });
        volSlider.addEventListener('input', (e) => {
            document.getElementById('volPerc').textContent = Math.round(e.target.value * 100) + "%";
            if (gainNode && !fadeStarted) gainNode.gain.setTargetAtTime(e.target.value, audioCtx.currentTime, 0.05);
        });
    </script>
</body>
</html>
