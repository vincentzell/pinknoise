<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sleepy Bobby - Timer Pro</title>
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --primary: #38bdf8;
            --bird-grey: #b8b0a5; --bird-dark-grey: #8d7e71; --bird-orange: #e65a28; --branch-brown: #8b5d43;
        }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; position: fixed; background: var(--bg); font-family: system-ui, sans-serif; color: var(--text); }
        body { display: flex; align-items: center; justify-content: center; }

        .anim-container { position: absolute; inset: 0; pointer-events: none; z-index: 999; overflow: hidden; }
        .container { width: 100%; max-width: 380px; padding: 20px; text-align: center; position: relative; z-index: 10; }
        .card { background: var(--card); padding: 2rem; border-radius: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(10px); }

        /* --- BOBBY --- */
        .play-btn-wrapper { position: relative; margin: 10px auto 30px; width: 160px; height: 160px; display: flex; justify-content: center; }
        .bobby-box { position: relative; width: 140px; height: 150px; transform-origin: center 85%; }
        .bird-body { width: 90px; height: 100px; background: var(--bird-grey); border-radius: 50% 50% 45% 45%; position: absolute; left: 25px; top: 10px; z-index: 30; overflow: hidden; transition: box-shadow 0.8s ease-in-out; }
        .chest { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 70px; height: 70px; background: var(--bird-orange); border-radius: 50%; transition: filter 0.8s ease-in-out; }
        .eye { width: 7px; height: 7px; background: #1a1a1a; border-radius: 50%; transition: all 0.3s; }
        .tail { width: 25px; height: 40px; background: var(--bird-grey); border-radius: 0 0 10px 10px; position: absolute; bottom: 25px; left: 57.5px; z-index: 20; }
        .legs { display: flex; gap: 15px; position: absolute; bottom: 38px; left: 50%; transform: translateX(-50%); z-index: 40; }
        .leg { width: 8px; height: 12px; background: var(--bird-dark-grey); border-radius: 3px; }
        .branch { position: absolute; width: 140px; height: 12px; background: var(--branch-brown); bottom: 35px; left: 0; border-radius: 10px; z-index: 50; }

        .playing .bird-body { animation: breathe 4s ease-in-out infinite; }
        .playing .eye { height: 2px; border-radius: 2px; margin-top: 3px; }
        .sway-active { animation: sway 6s ease-in-out infinite; }

        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.04); } }
        @keyframes sway { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }

        /* --- EFFETS VISUELS --- */
        .zzz { position: absolute; color: #fb7185; font-weight: bold; opacity: 0; animation: zMove 3s ease-out forwards; font-size: 32px; left: 50%; top: 35%; }
        @keyframes zMove { 0% { transform: translate(20px, 0) scale(0.5); opacity: 0; } 20% { opacity: 1; } 100% { transform: translate(60px, -120px) scale(1.5); opacity: 0; } }
        .wave-line { position: absolute; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, transparent, var(--primary), transparent); opacity: 0; animation: waveFlow 8s ease-in-out forwards; }
        @keyframes waveFlow { 0% { bottom: -5%; opacity: 0; } 50% { opacity: 0.4; } 100% { bottom: 105%; opacity: 0; } }
        .wind-gust { position: absolute; height: 20px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent); filter: blur(15px); border-radius: 50%; animation: drift 7s ease-in-out forwards; }
        @keyframes drift { from { left: -120%; } to { left: 120%; } }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 4s infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        .rain-drop { position: absolute; background: rgba(255,255,255,0.3); width: 1px; height: 30px; animation: fall 0.8s linear infinite; }
        @keyframes fall { to { transform: translateY(110vh); } }

        /* --- UI --- */
        .label-row { display: flex; justify-content: space-between; font-size: 0.75rem; font-weight: bold; text-transform: none; opacity: 0.7; margin-bottom: 5px; }
        .control-group { text-align: left; margin-top: 18px; }
        select { width: 100%; padding: 12px; border-radius: 12px; background: #2d3748; border: 1px solid rgba(255,255,255,0.1); color: white; cursor: pointer; appearance: none; }
    </style>
</head>
<body>
    <div class="anim-container" id="animContainer"></div>
    <div class="container">
        <div class="card">
            <h2 style="margin:0;">Sleepy Bobby</h2>
            <p id="bobbyPhrase" style="min-height:50px; font-size: 0.95rem; font-style: italic; margin: 10px 0; display: flex; align-items: center; justify-content: center;"></p>
            
            <div class="play-btn-wrapper">
                <div class="bobby-box" id="bobbyBox">
                    <div class="tail"></div>
                    <div class="bird-body" id="birdMain">
                        <div style="position:absolute;top:0;left:20%;width:60%;height:25px;background:var(--bird-dark-grey);border-radius:0 0 15px 15px;"></div>
                        <div class="chest" id="bChest"></div>
                        <div style="position:absolute;top:35px;width:45px;display:flex;justify-content:space-between;left:50%;transform:translateX(-50%);"><div class="eye"></div><div class="eye"></div></div>
                        <div style="position:absolute;top:42px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:7px solid #f1c40f;"></div>
                    </div>
                    <div class="legs"><div class="leg"></div><div class="leg"></div></div>
                    <div class="branch"></div>
                    <button id="playBtn" style="position:absolute; inset:0; background:none; border:none; cursor:pointer; z-index:100;"></button>
                </div>
            </div>

            <div class="control-group">
                <div class="label-row"><span>Ambiance</span></div>
                <select id="modeSelect">
                    <option value="pink">Bruit Rose</option>
                    <option value="waves">Vagues</option>
                    <option value="rain">Pluie</option>
                    <option value="wind">Vent</option>
                    <option value="fire">Cheminée</option>
                    <option value="space">Espace</option>
                </select>
            </div>

            <div class="control-group">
                <div class="label-row"><span>Minuteur</span></div>
                <select id="timerSelect">
                    <option value="0" data-base="Désactivé (∞)">Désactivé (∞)</option>
                    <option value="5" data-base="5 Minutes">5 Minutes</option>
                    <option value="15" data-base="15 Minutes">15 Minutes</option>
                    <option value="30" data-base="30 Minutes">30 Minutes</option>
                    <option value="60" data-base="60 Minutes">60 Minutes</option>
                </select>
            </div>

            <div class="control-group">
                <div class="label-row"><span>Volume <span id="volPerc">100%</span></span></div>
                <input type="range" id="volume" min="0" max="1" step="0.01" value="1.0" style="width:100%">
            </div>
        </div>
    </div>

    <script>
        const phrases = [
            "Bobby ébouriffe ses plumes pour te border.",
            "Chut... Bobby troque son chant contre un doux murmure.",
            "Un petit nid de sons pour une grande nuit de rêves.",
            "Bobby ferme un œil... puis l'autre... avec toi.",
            "Bobby says bonne nuit and wishes you sweet dreams.",
            "Un battement d'ailes, un petit chirp, et hop au dodo !",
            "Bobby is learning to snore in two languages.",
            "Bobby has his head in the clouds, entre Dublin et Paris.",
            "Bobby range son bec sous son aile, c'est l'heure.",
            "Le dernier rouge-gorge couché éteint la lune !",
            "Bobby rêve de trèfles irlandais et de jardins français.",
            "De Connemara à la Provence, Bobby te chante le sommeil.",
            "A little piece of Ireland, un petit coin de France, et beaucoup de dodo.",
            "Slán abhaile... Bobby te souhaite un doux retour au pays des songes."
        ];

        let audioCtx, gainNode, sourceNode, visualInterval, countdownInterval, lfo;
        let isPlaying = false, timeLeft = 0;

        async function initAudio(mode) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            if(sourceNode) try { sourceNode.stop(); } catch(e) {}
            if(lfo) try { lfo.stop(); } catch(e) {}

            sourceNode = audioCtx.createBufferSource();
            const bufferSize = audioCtx.sampleRate * 4;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            
            let b0=0, b1=0, b2=0; 
            for (let i = 0; i < bufferSize; i++) {
                let w = Math.random() * 2 - 1;
                if (mode === 'fire') {
                    data[i] = (Math.random() > 0.998) ? (Math.random() * 0.5) : (w * 0.04);
                } else {
                    b0 = 0.99886*b0 + w*0.0555; b1 = 0.99332*b1 + w*0.0750; b2 = 0.969*b2 + w*0.1538;
                    data[i] = (b0 + b1 + b2 + w * 0.53) * 0.11;
                }
            }

            sourceNode.buffer = buffer; sourceNode.loop = true;
            gainNode = audioCtx.createGain();
            gainNode.gain.value = document.getElementById('volume').value;
            const filter = audioCtx.createBiquadFilter();
            filter.type = "lowpass";

            if (mode === 'waves') {
                filter.frequency.value = 800;
                const waveGain = audioCtx.createGain();
                const constantGain = audioCtx.createGain();
                constantGain.gain.value = 0.15;
                lfo = audioCtx.createOscillator();
                lfo.frequency.value = 0.12;
                lfo.connect(waveGain.gain);
                sourceNode.connect(filter);
                filter.connect(waveGain).connect(gainNode);
                filter.connect(constantGain).connect(gainNode);
                lfo.start();
            } else {
                filter.frequency.value = (mode==='fire'? 3000 : mode==='wind'?300 : mode==='space'?150 : mode==='rain'?1500 : 2500);
                sourceNode.connect(filter).connect(gainNode);
            }
            gainNode.connect(audioCtx.destination);
            sourceNode.start();
        }

        function stopBobby() {
            isPlaying = false;
            if(sourceNode) try { sourceNode.stop(); } catch(e) {}
            if(lfo) try { lfo.stop(); } catch(e) {}
            document.getElementById('bobbyBox').classList.remove('playing');
            document.getElementById('bobbyBox').classList.remove('sway-active');
            clearInterval(visualInterval); 
            clearInterval(countdownInterval);
            document.getElementById('animContainer').innerHTML = '';
            document.getElementById('birdMain').style.boxShadow = "none";
            document.getElementById('bChest').style.filter = "none";
            const select = document.getElementById('timerSelect');
            Array.from(select.options).forEach(opt => opt.text = opt.getAttribute('data-base'));
        }

        async function startBobby() {
            isPlaying = true;
            document.getElementById('bobbyPhrase').textContent = phrases[Math.floor(Math.random()*phrases.length)];
            document.getElementById('bobbyBox').classList.add('playing');
            await initAudio(document.getElementById('modeSelect').value);
            updateVisuals();

            const select = document.getElementById('timerSelect');
            let mins = parseInt(select.value);
            if (mins > 0) {
                timeLeft = mins * 60;
                countdownInterval = setInterval(() => {
                    timeLeft--;
                    let m = Math.floor(timeLeft / 60), s = timeLeft % 60;
                    select.options[select.selectedIndex].text = `${m}:${s < 10 ? '0' : ''}${s} restant`;
                    if (timeLeft <= 30 && timeLeft > 0) {
                        let fade = (timeLeft / 30) * document.getElementById('volume').value;
                        gainNode.gain.setTargetAtTime(fade, audioCtx.currentTime, 0.5);
                    }
                    if (timeLeft <= 0) stopBobby();
                }, 1000);
            }
        }

        function updateVisuals() {
            const anim = document.getElementById('animContainer');
            const mode = document.getElementById('modeSelect').value;
            const bobby = document.getElementById('bobbyBox');
            const chest = document.getElementById('bChest');
            const mainBody = document.getElementById('birdMain');
            
            anim.innerHTML = ''; clearInterval(visualInterval);
            bobby.classList.remove('sway-active');
            chest.style.filter = "none";
            mainBody.style.boxShadow = "none";
            
            if (!isPlaying) return;

            if (mode === 'rain') {
                for(let i=0; i<30; i++) {
                    let d = document.createElement('div'); d.className = 'rain-drop';
                    d.style.left = Math.random()*100+'%'; d.style.animationDelay = Math.random()*2+'s';
                    anim.appendChild(d);
                }
            } else if (mode === 'space') {
                for(let i=0; i<40; i++) {
                    let s = document.createElement('div'); s.className = 'star';
                    s.style.width = s.style.height = Math.random()*3+'px';
                    s.style.left = Math.random()*100+'%'; s.style.top = Math.random()*100+'%';
                    anim.appendChild(s);
                }
            }

            visualInterval = setInterval(() => {
                if (mode === 'pink') {
                    let z = document.createElement('div'); z.className = 'zzz'; z.textContent = 'z';
                    anim.appendChild(z); setTimeout(() => z.remove(), 3000);
                } else if (mode === 'waves') {
                    let w = document.createElement('div'); w.className = 'wave-line';
                    anim.appendChild(w); setTimeout(() => w.remove(), 8000);
                } else if (mode === 'wind') {
                    bobby.classList.add('sway-active');
                    let g = document.createElement('div'); g.className = 'wind-gust';
                    g.style.top = Math.random()*100+'%'; g.style.width = (450+Math.random()*400)+'px';
                    anim.appendChild(g); setTimeout(() => g.remove(), 7000);
                } else if (mode === 'fire') {
                    const intense = 0.6 + Math.random() * 0.6;
                    chest.style.filter = `brightness(${intense}) saturate(1.6)`;
                    mainBody.style.boxShadow = `0 0 ${25 + intense * 35}px rgba(230, 90, 40, ${0.3 + intense * 0.3})`;
                }
            }, 1200);
        }

        document.getElementById('playBtn').addEventListener('click', () => {
            if (!isPlaying) startBobby(); else stopBobby();
        });

        document.getElementById('modeSelect').addEventListener('change', () => {
            if (isPlaying) startBobby();
        });

        document.getElementById('timerSelect').addEventListener('change', () => {
            stopBobby();
            startBobby();
        });

        document.getElementById('volume').addEventListener('input', (e) => {
            document.getElementById('volPerc').textContent = Math.round(e.target.value * 100) + "%";
            if(gainNode && isPlaying) gainNode.gain.setTargetAtTime(e.target.value, audioCtx.currentTime, 0.1);
        });
    </script>
</body>
</html>
